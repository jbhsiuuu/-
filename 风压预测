import streamlit as st
import torch
import numpy as np
import matplotlib.pyplot as plt


# 1. åˆå§‹åŒ–æ¨¡å‹
class WindGenerator(torch.nn.Module):  # ç»“æ„é¡»ä¸è®­ç»ƒæ—¶ä¸€è‡´
    def __init__(self):
        super().__init__()
        self.model = torch.nn.Sequential(
            torch.nn.Linear(1, 1024),
            torch.nn.Unflatten(1, (64, 4, 4)),
            torch.nn.ConvTranspose2d(64, 32, 4, 4, 0),
            torch.nn.ReLU(),
            torch.nn.ConvTranspose2d(32, 16, 4, 4, 0),
            torch.nn.ReLU(),
            torch.nn.ConvTranspose2d(16, 1, 4, 2, 1),
        )

    def forward(self, x): return self.model(x)


@st.cache_resource
def load_ai():
    model = WindGenerator()
    model.load_state_dict(torch.load('wind_predictor.pth'))
    model.eval()
    return model


st.title("ğŸ—ï¸ é«˜å±‚å»ºç­‘è¡¨é¢é£å‹ AI å®æ—¶é¢„æµ‹ç³»ç»Ÿ")
st.write("åŸºäº TPU æ•°æ®åº“ 32,768 å¸§é«˜é¢‘åŸå§‹æ•°æ®è®­ç»ƒ")

# 2. äº¤äº’æ§åˆ¶
angle = st.slider("é€‰æ‹©é£å‘è§’ (Wind Direction)", 0.0, 45.0, 15.0)

if st.button("å¼€å§‹ AI é¢„æµ‹"):
    model = load_ai()
    with torch.no_grad():
        input_angle = torch.tensor([[angle / 45.0]])
        output = model(input_angle).squeeze().numpy()

    # 3. ç»“æœå±•ç¤º
    fig, ax = plt.subplots()
    im = ax.imshow(output.T, cmap='jet', origin='lower')
    plt.colorbar(im, label="Predicted Cp (Mean)")
    ax.set_title(f"Predicted Wind Pressure Field at {angle}Â°")
    st.pyplot(fig)
    st.success(f"é¢„æµ‹å®Œæˆï¼é’ˆå¯¹ H=0.2m, B=0.1m å»ºç­‘æ¨¡å‹ä¼˜åŒ–")
